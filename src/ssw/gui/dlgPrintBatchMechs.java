/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

/*
 * dlgPrintBatchMechs.java
 *
 * Created on Jan 26, 2009, 1:59:24 PM
 */

package ssw.gui;
import java.awt.Image;
import java.awt.print.*;
import java.util.Vector;
import ssw.components.Mech;
import ssw.print.*;


/**
 *
 * @author Michael Mills
 */
public class dlgPrintBatchMechs extends javax.swing.JDialog {
    private class mechData{
        public String name;
        public Mech m;
        public dlgPrintSavedMechOptions POptions;

        public mechData (String name, Mech m, dlgPrintSavedMechOptions POptions){
            this.name = name;
            this.m = m;
            this.POptions = POptions;
        }

        @Override
        public String toString(){
            return name;
        }
    }

    private frmMain parent;
    private Vector<mechData> mechList;

    /** Creates new form dlgPrintBatchMechs */
    public dlgPrintBatchMechs(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
        this.parent = (frmMain) parent;
        initComponents();
        mechList = new Vector<mechData>();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jButton1 = new javax.swing.JButton();
        jScrollPane1 = new javax.swing.JScrollPane();
        lstChoosenMechs = new javax.swing.JList();
        btnRemoveMech = new javax.swing.JButton();
        btnPrintAll = new javax.swing.JButton();
        btnAddMech = new javax.swing.JButton();
        btnMechDetails = new javax.swing.JButton();
        btnCancel = new javax.swing.JButton();

        jButton1.setText("Cancel");

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Print Multiple Mechs");

        lstChoosenMechs.setSelectionMode(javax.swing.ListSelectionModel.SINGLE_SELECTION);
        lstChoosenMechs.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                lstChoosenMechsMouseClicked(evt);
            }
        });
        jScrollPane1.setViewportView(lstChoosenMechs);

        btnRemoveMech.setText("Remove Mech");
        btnRemoveMech.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnRemoveMechActionPerformed(evt);
            }
        });

        btnPrintAll.setText("Print");
        btnPrintAll.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnPrintAllActionPerformed(evt);
            }
        });

        btnAddMech.setText("Add Mech");
        btnAddMech.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnAddMechActionPerformed(evt);
            }
        });

        btnMechDetails.setText("Mech Details");
        btnMechDetails.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnMechDetailsActionPerformed(evt);
            }
        });

        btnCancel.setText("Cancel");
        btnCancel.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                btnCancelActionPerformed(evt);
            }
        });

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(getContentPane());
        getContentPane().setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jScrollPane1, javax.swing.GroupLayout.DEFAULT_SIZE, 293, Short.MAX_VALUE)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(btnPrintAll, javax.swing.GroupLayout.DEFAULT_SIZE, 85, Short.MAX_VALUE)
                            .addComponent(btnAddMech, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 85, Short.MAX_VALUE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                        .addComponent(btnMechDetails)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                            .addComponent(btnRemoveMech, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                            .addComponent(btnCancel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addComponent(jScrollPane1, javax.swing.GroupLayout.PREFERRED_SIZE, 252, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnRemoveMech)
                    .addComponent(btnMechDetails)
                    .addComponent(btnAddMech))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(btnPrintAll)
                    .addComponent(btnCancel))
                .addContainerGap())
        );

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void btnAddMechActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnAddMechActionPerformed
        Mech m = parent.LoadMech();
        if (m != null)
        {
            dlgPrintSavedMechOptions POptions = new dlgPrintSavedMechOptions (parent, true, m);
            String name = m.GetName();
            if (!m.GetModel().isEmpty())
                name += " " + m.GetModel();
            POptions.setLocationRelativeTo( parent );
            POptions.setVisible( true );
            mechList.add(new mechData(BuildMechName(m, POptions), m, POptions));
            lstChoosenMechs.setListData(mechList);
        }
    }//GEN-LAST:event_btnAddMechActionPerformed

    private void btnPrintAllActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnPrintAllActionPerformed
        Book pages = new Book();
        PrinterJob job = PrinterJob.getPrinterJob();
        job.setJobName("SSW Batch Print");
        
        for (int i = 0; i < mechList.size(); ++i){
            mechData current = mechList.get(i);
            Mech m = current.m;
            dlgPrintSavedMechOptions POptions = current.POptions;
            boolean useA4paper = POptions.UseA4Paper(),
            printCharts = POptions.PrintCharts(),
            printPilot = POptions.PrintPilot();
            String warriorName = POptions.GetWarriorName();
            int gunnerySkill = POptions.GetGunnery(),
            pilotingSkill =  POptions.GetPiloting();
            float adjustedBV = m.GetCurrentBV();

            PrintMech p = new PrintMech( this.parent, m, GetImage( m.GetSSWImage() ), false, useA4paper);
            p.SetPilotData( warriorName, gunnerySkill, pilotingSkill);
            p.SetOptions( printCharts, printPilot, adjustedBV );

            Paper paper = new Paper();
            if( useA4paper ) {
                // silly Europeans...
                paper.setSize( 595, 842 );
                paper.setImageableArea( 18, 18, 559, 806 );
            } else {
                // no need to set the size as Paper() defaults to 8.5" x 11"
                paper.setImageableArea( 18, 18, 576, 756 );
            }

            PageFormat page = new PageFormat();
            page.setPaper( paper );
            pages.append(p, page);
        }
        job.setPageable(pages);
        this.setVisible(false);
        boolean DoPrint = job.printDialog();
        if( DoPrint ) {
            try {
                job.print();
            } catch( PrinterException e ) {
                System.err.println( e.getMessage() );
                System.out.println( e.getStackTrace() );
            }
        }
    }//GEN-LAST:event_btnPrintAllActionPerformed

    private void btnMechDetailsActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnMechDetailsActionPerformed
        mechData selected = (mechData) lstChoosenMechs.getSelectedValue();
        if (selected == null){
            return;
        }
        dlgPrintSavedMechOptions POptions = selected.POptions;
        Mech m = selected.m;
        POptions.setLocationRelativeTo( parent );
        POptions.setVisible( true );
        selected.name = BuildMechName(m, POptions);
    }//GEN-LAST:event_btnMechDetailsActionPerformed

    private void btnRemoveMechActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnRemoveMechActionPerformed
        mechData selected = (mechData) lstChoosenMechs.getSelectedValue();
        if (selected == null){
            return;
        }
        mechList.remove(selected);
        lstChoosenMechs.setListData(mechList);
    }//GEN-LAST:event_btnRemoveMechActionPerformed

    private void btnCancelActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_btnCancelActionPerformed
        this.setVisible(false);
    }//GEN-LAST:event_btnCancelActionPerformed

    private void lstChoosenMechsMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_lstChoosenMechsMouseClicked
        if (evt.getClickCount() >= 2) {
            parent.CurMech = ((mechData) lstChoosenMechs.getSelectedValue()).m;
            parent.LoadMechIntoGUI();
            this.setVisible(false);
        }
    }//GEN-LAST:event_lstChoosenMechsMouseClicked

    public Image GetImage( String filename ) {
        java.awt.Toolkit toolkit = java.awt.Toolkit.getDefaultToolkit();
        Image retval = toolkit.getImage( filename );
        java.awt.MediaTracker mediaTracker = new java.awt.MediaTracker( this );
        mediaTracker.addImage( retval, 0 );
        try {
            mediaTracker.waitForID( 0 );
        } catch( InterruptedException ie ) {
            javax.swing.JOptionPane.showMessageDialog( this, "Interrupted while loading image " + filename );
            return null;
        }
        return retval;
    }

    private String BuildMechName(Mech m, dlgPrintSavedMechOptions po){
        String name = m.GetFullName();
        if (po.PrintPilot()) {
            name += " [" + po.GetWarriorName() + "]";
        }
        return name.replace(" []", "");
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton btnAddMech;
    private javax.swing.JButton btnCancel;
    private javax.swing.JButton btnMechDetails;
    private javax.swing.JButton btnPrintAll;
    private javax.swing.JButton btnRemoveMech;
    private javax.swing.JButton jButton1;
    private javax.swing.JScrollPane jScrollPane1;
    private javax.swing.JList lstChoosenMechs;
    // End of variables declaration//GEN-END:variables

}
